# berkeley_detection_platform_data_processing

## classification results 

### SKLearn VS PyTorch models:

:-------------------------:|:-------------------------:|:-------------------------:
![image](Results/SKLEARN_vs_PyTorch_LogReg_ROC.jpeg "SKLEARN_vs_PyTorch_LogReg_ROC")  |  ![image](Results/SKLEARN_vs_PyTorch_LogReg_L2_ROC.jpeg "SKLEARN_vs_PyTorch_LogReg_L2_ROC")  |  ![image](Results/SKLEARN_LogRegvs_PyTorch_CNN_LogReg_ROC.jpeg "SKLEARN_LogRegvs_PyTorch_CNN_LogReg_ROC")


## steps

### 1. Download the data
Download the 3% (33,000) samples from the "Malicious Content Detection Platform Project Homepage" at the following link:
http://secml.cs.berkeley.edu/detection_platform/release_tarball.tar.gz

### 2. Extract the cuckoo reports
Extract the cuckoo reports from the tarball file (the files named behaviour_0000 and begin with the word "info").

### 3. Process the cuckoo reports
Each file contains multiple cuckoo reports, and the following script extracts each report to a single report file.
The script is setting a minimum syscalls-sequnce-length and the following are the filtered results.Scripts/script1_flatter_cuckoo_reports.py
Data/list_of_16K_hashes_with_seq_len_limit.txt

### 4. Extract the VT reports
Extract the virus-total (VT) reports from the tarball file (the files named reports_0000 and begin with the word "vhash"). 

### 5. Process the VT reports
Each file contains multiple VT reports, and the following script extract some fields (sample-hash, malicious-score, sample-first-seen) from each report and store them in a single file:
Scripts/script2_vt_to_json.py
Data/dict_hash_to_score_time.json

### 6. Train-Test Split
The train-test split is done by considering both malicious-benign-ratio (for simplicity purposes it uses the ratio of 50%-malwares 50%-benign files) within the datasets and time consistency between the datasets.
Scripts/script3_notebook_split_by_score_time.ipynb

### 7. Build classifier
The following notebook implements malware classification basing on syscalls-NGrams frequency which appeares in the cuckoo report.
Scripts/script4_notebook_malware_classifier_models_comparison.ipynb

### 8. Results
We've built a dataset with 1,000 samples with the ratio of 50%-malwares 50%-benign files, while holding a time-consistency with samples in the train-set are all first-seen 4-months before samples in the test-set:
        train: 2012-01-01 - 2013-06-01	
        test : 2013-10-01 - 2014-06-01
Top 3 models: (by precision metric)
{'model': '10 Random Forest 5-max-depth with (4, 4)-Grams-TfidfVectorizer-vectorizer', 'score': 0.909}
{'model': 'RF with (1, 2)-Grams-CountVectorizer-vectorizer', 'score': 0.859}
{'model': '10 Random Forest 5-max-depth with (1, 4)-Grams-TfidfVectorizer-vectorizer', 'score': 0.833}
